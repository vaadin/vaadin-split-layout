<!--
@license
Copyright (c) 2016 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<!--
`<vaadin-split-layout>` is a Polymer element implementing a split layout for two
content elements with a draggable splitter between them.

```html
<vaadin-split-layout>
  <div>First layout content</div>
  <div>Second layout content</div>
</vaadin-split-layout>
```

### Horizontal and Vertical Layouts

By default, the split is horizontal, meaning that the content elements are
positioned side by side in a flex container with a horizontal layout.

You can change the split mode to vertical by adding the `vertical` attribute:

```html
<vaadin-split-layout vertical>
  <div>Content on the top</div>
  <div>Content on the bottom</div>
</vaadin-split-layout>
```

You can also trigger the vertical mode by setting the property:
`splitLayout.vertical = true`.

### Initial Sizes and Size Limits

The initial sizes for the content elements are determined from their size values
corresponding to the split layout. `width` is used for the horizontal
layout, while `height` is used for the vertical one. Then the sizes of the
content elements are scaled proportionally to fit in the split layout size.

The `min-width`/`min-height`, and `max-width`/`max-height` CSS size values
for the content elements are respected and used to limit the splitter position
when it is dragged.

### Resize Notification

This element implements `IronResizableBehavior` to notify the nested resizables
when the splitter is dragged. In order to define a resizable and receive that
notification in a nested element, include `IronResizableBehavior` and listen
for the `iron-resize` event.

The following custom properties are available for styling:

Custom property | Description | Default
:----------------|:-------------|----------:
`--vaadin-split-layout-splitter`|A mixin that is applied to the splitter|`{}`

@element vaadin-split-layout
@demo demo/index.html
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="vaadin-split-layout">
  <template>
    <style>
      :host {
        overflow: hidden;
      }

      :host(:not([vertical])) {
        @apply(--layout-horizontal);
      }

      :host([vertical]) {
        @apply(--layout-vertical);
      }

      :host ::content > * {
        @apply(--layout-flex-auto);
        overflow: auto;
      }

      #splitter {
        @apply(--layout-flex-none);
        position: relative;
        overflow: visible;
        min-width: 8px;
        min-height: 8px;
        background: var(--divider-color, #ccc);
        fill: var(--primary-background-color, #fff);
        @apply(--vaadin-split-layout-splitter);
      }

      :host(:not([vertical])) > #splitter {
        cursor: ew-resize;
      }

      :host([vertical]) > #splitter {
        cursor: ns-resize;
      }

      #handle,
      #splitter ::content > .splitter-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      #handle {
        padding: 0 11px;
      }

      :host([vertical]) > #splitter > #handle {
        transform: translate(-50%, -50%) rotate(90deg);
      }
    </style>
    <content select="[vaadin-split-layout=primary]" id="primary"></content>
    <div id="splitter" on-track="_onHandleTrack" on-down="_preventDefault">
      <content select=".splitter-icon">
        <svg id="handle" width="2" height="24">
          <rect width="100%" height="100%"></rect>
        </svg>
      </content>
    </div>
    <content select="[vaadin-split-layout=secondary]" id="secondary"></content>
  </template>

  <script>
    Polymer({

      is: 'vaadin-split-layout',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      properties: {
        /**
         * Change the split layout to vertical
         */
        vertical: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        }
      },

      attached: function() {
        this._observer = Polymer.dom(this).observeNodes(this._processChildren);
      },

      detached: function() {
        Polymer.dom(this).unobserveNodes(this._observer);
      },

      _processChildren: function() {
        var children = this.getEffectiveChildren();
        var layouts = children.filter(function(child, i) {
          return !child.classList.contains('icon-vertical') &&Â !child.classList.contains('icon-horizontal');
        }).forEach(function(child, i) {
          if (i == 0) {
            this._primaryChild = child;
            Polymer.dom(child).setAttribute('vaadin-split-layout', 'primary');
          } else if (i == 1) {
            this._secondaryChild = child;
            Polymer.dom(child).setAttribute('vaadin-split-layout', 'secondary');
          } else {
            Polymer.dom(child).removeAttribute('vaadin-split-layout');
          }
        }.bind(this));
      },

      _setFlexBasis: function(element, flexBasis, containerSize) {
        flexBasis = Math.max(0, Math.min(flexBasis, containerSize));
        if (flexBasis === 0) {
          // Pure zero does not play well in Safari
          flexBasis = 0.000001;
        }
        ['-ms-flex', '-webkit-flex', 'flex'].forEach(function(prop) {
          element.style[prop] = '1 1 ' + flexBasis + 'px';
        });
      },

      _onHandleTrack: function(event) {
        if (!this._primaryChild || !this._secondaryChild) {
          return;
        }

        var size = this.vertical ? 'height' : 'width';
        if (event.detail.state === 'start') {
          this._startSize = {
            container: this.getBoundingClientRect()[size] - this.$.splitter.getBoundingClientRect()[size],
            primary: this._primaryChild.getBoundingClientRect()[size],
            secondary: this._secondaryChild.getBoundingClientRect()[size]
          };
          return;
        }

        var distance = this.vertical ? event.detail.dy : event.detail.dx;
        this._setFlexBasis(this._primaryChild, this._startSize.primary + distance, this._startSize.container);
        this._setFlexBasis(this._secondaryChild, this._startSize.secondary - distance, this._startSize.container);

        this.notifyResize();

        if (event.detail.state === 'end') {
          delete this._startSize;
        }
      },

      _preventDefault: function(event) {
        event.preventDefault();
      }

    });

    /**
     * Fired when the splitter is dragged. Non-bubbing. Fired for the splitter
     * element and any nested elements with `IronResizableBehavior`.
     *
     * @event iron-resize
     */
  </script>
</dom-module>
